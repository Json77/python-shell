# ironic部署vlan网络场景

本节描述 ironic 在 VLAN 环境的部署场景。


## 场景概述

ironic在社区Ocata版本之后，允许采用一个专用的网络用于部署。这个特性扩展了ironic服务的网络场景。ironic在结合网络服务之后，允许在一个分布的部署网络内部署节点，完成之后加入不同的租户网络。但是，目前仍然不支持将裸机网口配成属于多个网络的trunk模式。

完成这个场景需要网络插件，来为裸机处理网络翻转。目前ironic设置允许3种网络：
- noop：用于ironic独立部署，不需要任何网络切换。
- flat：将所有的部署完成的节点和待部署的节点都放在一个单独的二层网络之中，从
- neutron：结合网络服务，提供指定的租户网络，并将租户网络与部署、清除网络隔离。设置neutron网络的配置详见用户手册中neutron网络特性。

物理环境组网由管理员和现场施工网络专家完成，ironic 安装配置请参考安装指南。

## 物理节点框架

![](fig_vlan_physical_net.png)

物理节点框架图

## 服务组件分布

![](fig_service_distribution.png)

各个服务组件在节点的分布情况如图所示。


## 网络平面图

![](fig_vlan_network_planes.png)

## DC内的IP、VLAN规划

| **序号** | **网络平面**   | **节点**          | **物理网卡需求**  | **子接口名称**   | **VLAN****规划** | **IP****地址需求**                    | **是否对外** |
| ------ | ---------- | --------------- | ----------- | ----------- | -------------- | --------------------------------- | -------- |
| 1      | PXE        | Ironic控制节点      | 第一对集成GE网卡绑定 | Bond0       | 800            | Daisy自动分配                         | 否        |
|        |            | Openstack控制节点   | 第一对集成GE网卡绑定 | Bond0       | 800            | Daisy自动分配                         | 否        |
| 2      | Outband    | Provider        | 第一对集成GE网卡绑定 | Bond0.700   | 700            | 局方申请一个24位掩码段                      | 是        |
|        |            | 计算节点            | IPMI管理网口    | 待定          | 700            |                                   | 是        |
|        |            | Ironic控制节点      | IPMI管理网口    | 待定          | 700            |                                   | 是        |
|        |            | Ironic控制节点      | 第一对集成GE网卡绑定 | Bond0   700 | 700            |                                   |          |
|        |            | Openstack控制节点   | IPMI管理网口    | 待定          | 700            |                                   | 是        |
| 3      | TECSClinet | Openstack控制节点   | 第一对集成GE网卡绑定 | Bond0.802   | 802            | 局方申请一个24位掩码段                      | 是        |
| 4      | PublicApi  | Openstack控制节点   | 第一对集成GE网卡绑定 | Bond0.803   | 803            | 是                                 |          |
| 5      | Management | Ironic  控制节点    | 第一对集成GE网卡绑定 | Bond0.801   | 801            | 内部规划一个24位掩码段                      | 否        |
|        |            | Openstack  控制节点 | 第一对集成GE网卡绑定 | Bond0.801   | 801            |                                   | 否        |
| 6      | Heartbeat  | Openstack  控制节点 | 第二对集成GE网卡绑定 | Bond9       | 998            | 内部规划一个29位掩码段                      | 否        |
| 7      | DataPlane  | 计算节点            | 第一个网口       | 无           | Vxlan          | APP独立申请                           | 是        |
| 8      | Inspect    | Ironic  控制节点    | 第二对GE网卡绑定   | Bond1.  10  | 10             | 内部规划一个29位掩码段                      | 否        |
|        |            | 计算节点            | 第一个网口       | 无           | 10             | 动态获取地址                            | 否        |
| 9      | Provision  | Ironic  控制节点    | 第二对GE网卡绑定   | Bond1.  11  | 11             | 内部从保留的Provison网段分配一个保留地址，使用24位掩码段 | 否        |
|        |            | 计算节点            | 第一个网口       | 无           | 11             | 动态获取Provision网段地址                 | 否        |


## ironic物理环境分配

![](fig_vlan_compute_allocation.png)

## 部署节点列表

对于一套网络组，至少需要一套控制节点与计算节点，如果需要HA，则需要两台互为主备。

| 节点类型                 | 节点数  | 节点规格 | 说明       |          |      |      |      |
| -------------------- | ---- | ---- | -------- | -------- | ---- | ---- | ---- |
| 核数                   | 内存   | 网口数  | 系统盘  （G） | 数据盘  （G） |      |      |      |
| OpenStack ironic部署节点 | 2    | 8    | 32       | 4        | 200  | 900  |      |
| OpenStack控制节点        | 2    | 8    | 32       | 6        | 200  | 900  |      |

注：

1. openstack ironic部署节点
    1. 代理节点采用HA，每POD使用2台VM
    2. 按POD扩展，每增加1个POD（50台服务器），增加OpenStack代理节点4Core/16G
    3. 代理节点采用Scale Out水平扩展
2. openstack控制节点
    1. 该资源池需配置2个控制节点
    2. 按POD扩展，每增加5POD，增加OpenStack控制节点8Core/32G。
    3. 控制节点采用Scale Up垂直扩展，当VM规格超出服务器上限时采用Scale Out增加控制节点扩展。


## 运维流程（用户操作）

运维流程可以分为以下几步：
1. 准备设备的物理环境，请参考 ironic 安装文档。
2. 将裸机加入组网，注册节点，请参考裸机注册文档。
3. 管理员执行inspect操作，请参考裸机发现文档。
4. 执行部署操作，请参考裸机部署文档。
